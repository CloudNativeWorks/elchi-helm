name: Release elchi-stack Chart

on:
  push:
    paths:
      - 'charts/elchi-stack/**'
    branches: [main]
  workflow_dispatch:

# Set permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow builds to run in parallel, but only one GitHub Pages deployment at a time
concurrency:
  group: "pages-deploy"
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.16.3

    - name: Lint chart
      run: |
        helm lint charts/elchi-stack --strict

    - name: Validate values schema
      run: |
        if [ -f charts/elchi-stack/values.schema.json ]; then
          echo "Values schema found, validation will be done by Helm"
          # Helm automatically validates against schema during template/install
          helm template charts/elchi-stack --values charts/elchi-stack/values.yaml > /dev/null
        else
          echo "No values schema found, skipping validation"
        fi

    - name: Validate Grafana dashboards
      run: |
        if [ -d charts/elchi-stack/charts/grafana/dashboards ]; then
          echo "Validating Grafana dashboard JSON files..."
          for dashboard in charts/elchi-stack/charts/grafana/dashboards/*.json; do
            if [ -f "$dashboard" ]; then
              echo "Validating $(basename $dashboard)..."
              if ! jq empty "$dashboard" 2>/dev/null; then
                echo "Error: Invalid JSON in $dashboard"
                exit 1
              fi
              echo "✓ $(basename $dashboard) is valid JSON"
            fi
          done
        else
          echo "No Grafana dashboards found, skipping validation"
        fi

    - name: Test chart installation
      run: |
        # Test with required values
        helm template test-release charts/elchi-stack \
          --set global.mainAddress="test.example.com" \
          --dry-run > /dev/null
        echo "✓ Chart templates render successfully"

    - name: Package chart
      run: |
        helm dependency update charts/elchi-stack
        helm package charts/elchi-stack --destination .deploy

    - name: Prepare deployment directory
      run: |
        mkdir -p .gh-pages
        # Copy existing static files if they exist
        cp CNAME .gh-pages/ 2>/dev/null || echo "No CNAME file found"
        cp logo.png .gh-pages/ 2>/dev/null || echo "No logo file found"
        cp index.html .gh-pages/ 2>/dev/null || echo "No index.html file found"

    - name: Wait to avoid race conditions
      run: |
        # Add a small delay to reduce race condition chances
        # elchi-stack gets no delay, elchi-discovery gets 30s delay
        echo "Waiting before deployment to avoid race conditions..."
        sleep 5
        
    - name: Download existing index.yaml
      run: |
        # Try to download existing index.yaml from GitHub Pages with retry
        for i in {1..3}; do
          if curl -f -s -o .gh-pages/index.yaml https://charts.elchi.io/index.yaml; then
            echo "Successfully downloaded existing index.yaml"
            break
          else
            echo "Attempt $i failed to download index.yaml"
            if [ $i -eq 3 ]; then
              echo "No existing index.yaml found after 3 attempts"
            else
              sleep 10
            fi
          fi
        done
        
    - name: Download existing chart packages
      run: |
        # Download all existing .tgz files if index.yaml exists
        if [ -f .gh-pages/index.yaml ]; then
          echo "Downloading existing chart packages..."
          # Extract chart URLs from existing index.yaml and download them
          if grep -q 'https://charts\.elchi\.io/[^"]*\.tgz' .gh-pages/index.yaml; then
            grep -o 'https://charts\.elchi\.io/[^"]*\.tgz' .gh-pages/index.yaml | sort -u | while read url; do
              filename=$(basename "$url")
              echo "Downloading $filename..."
              for attempt in {1..2}; do
                if curl -f -s -o ".gh-pages/$filename" "$url"; then
                  echo "Successfully downloaded $filename"
                  break
                else
                  echo "Attempt $attempt failed to download $filename"
                  if [ $attempt -eq 2 ]; then
                    echo "Failed to download $filename after 2 attempts"
                  else
                    sleep 5
                  fi
                fi
              done
            done
          else
            echo "No chart packages found in existing index.yaml"
          fi
        else
          echo "No existing index.yaml to process"
        fi

    - name: Update Helm repository
      run: |
        cp .deploy/*.tgz .gh-pages/
        cp artifacthub-repo.yml .gh-pages/ 2>/dev/null || true
        touch .gh-pages/.nojekyll
        echo "charts.elchi.io" > .gh-pages/CNAME
        # Remove README files that interfere with index.yaml
        rm -f .gh-pages/README.md .gh-pages/CLAUDE.md
        # Generate/update index.yaml (replaces existing)
        echo "Generating index.yaml..."
        helm repo index .gh-pages --url https://charts.elchi.io
        
    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .gh-pages

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4